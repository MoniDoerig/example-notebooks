name: check_broken_links

on:
  schedule:
    - cron: 30 17 * * *
  push:
    paths:
      - '**/*.ipynb'
  pull_request:
    paths:
      - '**/*.ipynb'
  # Trigger the workflow on manual dispatch
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  get-notebooks:
    runs-on: ubuntu-22.04
    outputs:
      notebook_list: ${{ steps.list_all_notebooks.outputs.notebook_list }}
    steps:
    - uses: actions/checkout@v4
    - name: Get all notebooks
      working-directory: ./books
      id: list_all_notebooks
      run: |
        all_notebooks=($(find . -type f -name "*.ipynb"))
        notebook_list='['
        for NOTEBOOK in "${all_notebooks[@]}"; do
          echo "NOTEBOOK=${NOTEBOOK}"
          notebook_list+="\"${NOTEBOOK}\","
        done
        notebook_list=$(sed '$s/,$//' <<< $notebook_list)
        notebook_list+=']'
        echo "notebook_list=${notebook_list}"
        echo "notebook_list=${notebook_list}" >> $GITHUB_OUTPUT

  check-links:
    needs: [ get-notebooks ]
    if: ${{ needs.get-notebooks.outputs.notebook_list != '[]' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: lychee Link Checker
        id: lychee
        uses: lycheeverse/lychee-action@v1.8.0
        with:
          args: --accept=200,401,403,429
          fail: true
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}